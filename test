link_list = []
dl_folder = r'C:\Users\ryuic\Downloads'
years = list(range(2022, 2023, 1))
for year in years:
    time.sleep(3)
    sdate = f'Jan 01, {year}'
    sdate_input = driver.find_element_by_name('FirstCohortDate')

    actions = ActionChains(driver)
    actions.move_to_element(sdate_input).perform()
    sdate_input.clear()
    sdate_input.send_keys(sdate)
    sdate_input.send_keys(Keys.TAB)
    driver.find_element_by_id('ApplyFilterBtn').click()
    time.sleep(5)

    total_list = driver.find_elements_by_class_name('total')        
    for i in tqdm(range(len(total_list)), postfix=f'working on {year}'):
        # open issuer list page
        actions = ActionChains(driver)
        actions.move_to_element(total_list[i]).perform()
        total_list[i].click()

        # switch controlling window
        handle_array = driver.window_handles
        if len(handle_array) > 1:
            driver.switch_to.window(handle_array[1])

            # export excel output
            time.sleep(3)
            driver.find_element_by_id('ExportBtn').click()

            # check total page
            total_page = int(driver.find_element_by_class_name('pageTotal').text)
            
            # get company links
            time.sleep(5)
            table = driver.find_element_by_class_name('ratingHistoryContentDetailTableContent')
            a_list = table.find_elements_by_tag_name('a')
            link_list = link_list + [x.get_attribute('href') for x in a_list if x.get_attribute('href') != 'javascript:void(0)']
            
            if total_page > 1:
                for j in range(total_page-1):
                    driver.find_element_by_class_name('paggingArrowRight').click()
                    time.sleep(3)
                    table = driver.find_element_by_class_name('ratingHistoryContentDetailTableContent')
                    a_list = table.find_elements_by_tag_name('a')
                    link_list = link_list + [x.get_attribute('href') for x in a_list if x.get_attribute('href') != 'javascript:void(0)']

            # close page
            driver.close()
            driver.switch_to.window(handle_array[0])

            # rename file
            os.rename(f'{dl_folder}/WP-Issuer List.xlsx', f'{dl_folder}/{year}_{str(i).zfill(2)}.xlsx')
